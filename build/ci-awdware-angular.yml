pool:
  vmImage: "ubuntu-latest"

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "12.x"
    displayName: "Install Node.js"

  - task: YarnInstaller@3
    inputs:
      versionSpec: "1.x"
      checkLatest: true

  - task: Yarn@3
    inputs:
      projectDirectory: "Src/"
      arguments: "install"
    displayName: "yarn install"

  - task: Yarn@3
    inputs:
      projectDirectory: "Src/Awdware.Host/Awdware.Host.Presentation"
      arguments: "global add @awdware/gah"

  - task: SonarCloudPrepare@1
    continueOnError: true
    displayName: "Prepare analysis on SonarCloud"
    inputs:
      SonarCloud: "sonarcloud"
      organization: "awdware"
      scannerMode: CLI
      configMode: manual
      cliProjectKey: "awdware:presentation"
      cliSources: presentation
      extraProperties: |
        sonar.sources=Src/**/Awdware.*.Presentation/src/projects/awdware-*/src
        sonar.sourceEncoding=UTF-8
        sonar.exclusions=**/node_modules/**,**/*.spec.ts,**/.deps/**
        sonar.tests=Src/**/Awdware.*.Presentation/src/projects/awdware-*/src
        sonar.test.inclusions=**/*.spec.ts
        sonar.ts.tslintconfigpath=Src/Awdware.Host/Awdware.Host.Presentation/.gah/tslint.json

  - task: CmdLine@2
    inputs:
      script: 'gah install'
      workingDirectory: 'Src/Awdware.Host/Awdware.Host.Presentation'
      failOnStderr: true
    displayName: "Gah install"

  - task: CmdLine@2
    inputs:
      script: 'gah run -e prod ng build --prod'
      workingDirectory: 'Src/Awdware.Host/Awdware.Host.Presentation'
      failOnStderr: true
    displayName: "Build host and dependencies"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "Src/Awdware.Host/Awdware.Host.Presentation/dist/"
      ArtifactName: "drop"
      publishLocation: "Container"
    displayName: publish build

  - task: SonarCloudAnalyze@1
    displayName: "Run Code Analysis"
    continueOnError: true

  - task: SonarCloudPublish@1
    displayName: "Publish Quality Gate Result"
    continueOnError: true
    inputs:
      pollingTimeoutSec: "300"
